<div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
  <div class="widget">
    <h2 class="title">
      <span data-lang="custom-commands"></span>
      <button class="btn btn-primary" onclick="cc.newCommand()"><i class="fa fa-plus" aria-hidden="true"></i></button>
      <div class="btn-group">
        <button id="save-button" class="btn btn-success new-confirm-btn" style="display:none" onclick="cc.createCommand(event)">SAVE</button>
        <button class="btn btn-warning new-confirm-btn" style="display:none" onclick="cc.cancelNewCommand()">CANCEL</button>
      </div>
    </h2>
    <table class="table table-striped table-responsive table-condensed">
      <tbody id="Commands"></tbody>
    </table>
  </div>
</div>

<script>
  var cc = {
    list: {},
    cancelNewCommand: function () {
      $('#new-command').css('display', 'none')
      $('.new-confirm-btn').css('display', 'none')
      this.updateCommands(this.list)
    },
    newCommand: function () {
      $('#new-command').css('display', 'table-row')
      $('.new-confirm-btn').css('display', 'block')

      $('[contenteditable=true]').off()
      $('#new-command [contenteditable=true]:first').keyup(function (ev) {
        var command = $(ev.target).text().trim()
        if (!command.startsWith('!')) command = '!' + command
        socket.emit('parser.isRegistered', { emit: 'alias.check', command: command })
      })
    },
    stub: function (id, value) {
      return // do nothing
    },
    updateCommands: function (list) {
      this.list = list
      $("#Commands").empty()
      $("#Commands").append('<tr id="new-command" style="display:none">' +
          '<td style="vertical-align: top !important;"><span class="label label-default">New command</span> <span class="status label label-warning">available</span>' + commons.editable('', '_new!', 'cc.stub') + '</td>' +
          '<td style="vertical-align: top !important;"><span class="label label-primary">Response</span> ' +
              commons.editable('<empty response>', '_new!', 'cc.stub') +
          '</td>' +
          '</tr>');
      _.each(list, function(item, index) {
        $("#Commands").append('<tr>' +
          '<td style="vertical-align: top !important;"><span class="label label-default">Command</span>' + commons.editable('!' + item.command, item.command, 'cc.editCommandName') + '</td>' +
          '<td style="vertical-align: top !important;"><span class="label label-primary">Response</span> ' +
            '<span style="cursor: pointer;" class="label label-' + (item.visible ? "success": "danger") + '" " data-command="' + item.command + '" onclick="cc.toggleVisibilityCommand(this)">' + (item.visible ? "visible": "hidden") + '</span> ' +
            '<span style="cursor: pointer;" class="label label-' + (item.enabled ? "success": "danger") + '" data-command="' + item.command + '" onclick="cc.toggleCommand(this)">' + (item.enabled ? "enabled": "disabled") + '</span>' +
            '<span style="cursor: not-allowed; float:right; padding: 4px;" class="label label-danger btn-remove" data-command="' + item.command + '"  onclick="commons.confirm(this)">delete</span>' +
            '<span style="cursor: not-allowed; float:right; padding: 4px; display: none" class="label label-warning btn-confirm" onclick="commons.unconfirm(this)">cancel</span>' +
            '<span style="cursor: not-allowed; float:right; padding: 4px; display: none" class="label label-success btn-confirm" onclick="cc.deleteCommand(this)" data-command="' + item.command + '">confirm</span>' +
            commons.editable(item.response, item.command, 'cc.editCommand') +
          '</td>' +
          '</tr>');
      })
    },
    editCommandName: function (id, value) {
      socket.emit('commands.edit.id', {id: id, value: value})
    },
    editCommand: function (id, value) {
      socket.emit('commands.edit', {id: id, value: value})
    },
    deleteCommand: function (el) {
      socket.emit('commands.delete', el.dataset.command)
    },
    toggleCommand: function (el) {
      socket.emit('commands.toggle', el.dataset.command)
    },
    toggleVisibilityCommand: function (el) {
      socket.emit('commands.toggle.visibility', el.dataset.command)
    },
    createCommand: function (event) {
      event.preventDefault()
      var inputs = $('[data-id="_new!"]')
      var data = {command: $(inputs[0]).text().replace('!', ''), response: $(inputs[1]).text()}
      socket.emit('commands.create', data).emit('commands.get')
      $('.new-confirm-btn').css('display', 'none')
    }
  }

  socket.emit('commands.get');

  socket.on('commands', function(list) {
    cc.updateCommands(list)
  });

  socket.on('alias.check', function (data) {
    if (data.isRegistered) {
      $('.status').removeClass().addClass('label label-danger status')
      $('#save-button').prop('disabled', true)
    } else {
      $('.status').removeClass().addClass('label label-success status')
      $('#save-button').prop('disabled', false)
    }
  })

  window.cc = cc
</script>
